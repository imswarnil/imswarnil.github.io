{% comment %}
  utility/toc.html
  - Bento-styled TOC with donut progress + scrollspy
  - Single toggle bar (desktop + mobile), mobile bottom dock
  - JSON-LD ItemList for all included headings
{% endcomment %}

{% capture tocWorkspace %}
  {% capture my_toc %}{% endcapture %}
  {% capture toc_ld_items %}{% endcapture %}
  {% assign orderedList  = include.ordered | default: false %}
  {% assign minHeader    = include.h_min | default: 2 %}
  {% assign maxHeader    = include.h_max | default: 3 %}
  {% assign nodes        = include.html | split: '<h' %}
  {% assign firstHeader  = true %}
  {% assign toc_index    = 0 %}

  {% capture listModifier %}{% if orderedList %}1.{% else %}-{% endif %}{% endcapture %}

  {% for node in nodes %}
    {% if node == "" %}{% continue %}{% endif %}

    {% assign headerLevel = node | replace: '"', '' | slice: 0, 1 | times: 1 %}

    {% if headerLevel < minHeader or headerLevel > maxHeader %}
      {% continue %}
    {% endif %}

    {% if firstHeader %}
      {% assign firstHeader = false %}
      {% assign minHeader = headerLevel %}
    {% endif %}

    {% assign indentAmount = headerLevel | minus: minHeader %}
    {% assign _workspace = node | split: '</h' %}

    {% assign _idWorkspace = _workspace[0] | split: 'id="' %}
    {% assign _idWorkspace = _idWorkspace[1] | split: '"' %}
    {% assign html_id = _idWorkspace[0] %}

    {% assign _classWorkspace = _workspace[0] | split: 'class="' %}
    {% assign _classWorkspace = _classWorkspace[1] | split: '"' %}
    {% assign html_class = _classWorkspace[0] %}

    {% if html_class contains "no_toc" %}
      {% continue %}
    {% endif %}

    {% capture _hAttrToStrip %}{{ _workspace[0] | split: '>' | first }}>{% endcapture %}
    {% assign header = _workspace[0] | replace: _hAttrToStrip, '' %}

    {% assign space = '' %}
    {% for i in (1..indentAmount) %}
      {% assign space = space | prepend: '    ' %}
    {% endfor %}

    {% unless include.item_class == blank %}
      {% capture listItemClass %}{:.{{ include.item_class | replace: '%level%', headerLevel }}}{% endcapture %}
    {% endunless %}

    {% capture heading_body %}{{ header | strip_html }}{% endcapture %}

    {% capture my_toc %}{{ my_toc }}
{{ space }}{{ listModifier }} {{ listItemClass }} [{{ heading_body | replace: "|", "\|" }}]({% if include.baseurl %}{{ include.baseurl }}{% endif %}#{{ html_id }}){% endcapture %}

    {%- comment -%} JSON-LD item for this heading {%- endcomment -%}
    {% assign toc_index = toc_index | plus: 1 %}
    {% assign abs_page = page.url | absolute_url %}
    {% capture toc_ld_items %}
{{ toc_ld_items }}{% if toc_index > 1 %},{% endif %}
{
  "@type": "ListItem",
  "position": {{ toc_index }},
  "item": {
    "@type": "WebPageElement",
    "@id": "{{ abs_page }}#{{ html_id }}",
    "url": "{{ abs_page }}#{{ html_id }}",
    "name": {{ heading_body | strip | jsonify }}
  }
}
    {% endcapture %}
  {% endfor %}
{% endcapture %}
{% assign tocWorkspace = '' %}

{% assign contentsTitle = include.contents_title | default: 'Contents' | strip %}

{% if my_toc != '' %}
<section class="toc-shell" data-toc>
  <!-- Top toggle bar (desktop sticky / mobile bottom dock) -->
  <button class="toc-toggle" type="button" data-toc-toggle aria-expanded="true">
    <span class="toc-toggle-left">
      <span class="toc-progress" aria-hidden="true">
        <svg class="toc-progress-svg" viewBox="0 0 40 40">
          <circle class="toc-progress-track" cx="20" cy="20" r="16" />
          <circle class="toc-progress-bar" cx="20" cy="20" r="16" />
          <text class="toc-progress-text" x="20" y="21" text-anchor="middle" dominant-baseline="middle">
            0
          </text>
        </svg>
      </span>
      <span class="toc-toggle-label">{{ contentsTitle }}</span>
    </span>
    <span class="toc-toggle-icon" aria-hidden="true">
      <i class="ph-bold ph-caret-up"></i>
    </span>
  </button>

  <!-- Bento-style panel (transparent bg, dashed border) -->
  <div class="toc-panel toc-panel--open" data-toc-panel>
    <div class="toc-panel-inner">
      <nav class="toc-nav" aria-label="{{ contentsTitle }}">
        <div class="toc-nav-inner">
          {{ my_toc | markdownify | strip }}
        </div>
      </nav>
    </div>
  </div>
</section>

{%- if toc_ld_items != '' -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "@id": "{{ page.url | absolute_url }}#toc",
  "name": {{ contentsTitle | jsonify }},
  "itemListOrder": "Ascending",
  "itemListElement": [
{{ toc_ld_items | strip }}
  ]
}
</script>
{%- endif -%}

<script>
(function () {
  if (window.__IMS_TOC_INIT__) return;
  window.__IMS_TOC_INIT__ = true;

  function setupToc(shell) {
    if (!shell) return;

    var panel   = shell.querySelector("[data-toc-panel]");
    var toggle  = shell.querySelector("[data-toc-toggle]");
    var textEl  = shell.querySelector(".toc-progress-text");
    var bar     = shell.querySelector(".toc-progress-bar");
    var track   = shell.querySelector(".toc-progress-track");

    var links   = shell.querySelectorAll(".toc-nav a[href*='#']");
    var headingRoot = document.querySelector(".post-content") || document.querySelector("main") || document.body;
    var headings = headingRoot.querySelectorAll("h2[id], h3[id]");

    if (!panel || !toggle || !links.length || !headings.length) return;

    links.forEach(function (a) { a.classList.add("toc-link"); });
    headings.forEach(function (h) {
      h.setAttribute("data-toc-target", "true");
      h.style.scrollMarginTop = "5.5rem";
    });

    function isMobile() {
      return window.matchMedia("(max-width: 767px)").matches;
    }

    // Donut math
    var radius = 16;
    var circumference = 2 * Math.PI * radius;
    if (bar) {
      bar.style.strokeDasharray = circumference;
      bar.style.strokeDashoffset = circumference;
    }

    function setProgress(p) {
      if (p < 0) p = 0;
      if (p > 1) p = 1;

      var y = window.scrollY || window.pageYOffset || 0;
      var pct = Math.round(p * 100);
      if (y < 40) pct = 0;

      var normalized = pct / 100;

      if (textEl) textEl.textContent = pct;

      if (bar) {
        var offset = circumference * (1 - normalized);
        bar.style.strokeDashoffset = offset;
      }

      if (track && bar) {
        track.classList.toggle("toc-progress-track--done", pct >= 100);
        bar.classList.toggle("toc-progress-bar--done", pct >= 100);
      }
    }

    // Smooth scroll on click
    links.forEach(function (link) {
      link.addEventListener("click", function (e) {
        var href = link.getAttribute("href") || "";
        if (href.indexOf("#") === -1) return;
        var id = href.split("#").slice(-1)[0];
        var target = document.getElementById(id);
        if (!target) return;

        e.preventDefault();

        var rect = target.getBoundingClientRect();
        var absoluteTop = rect.top + window.pageYOffset;
        var offset = 80;

        window.scrollTo({
          top: absoluteTop - offset,
          behavior: "smooth"
        });

        try {
          history.replaceState(null, "", "#" + id);
        } catch (err) {}

        if (isMobile()) closePanel();
      });
    });

    function openPanel() {
      shell.classList.add("toc-shell--open");
      panel.classList.add("toc-panel--open");
      panel.style.maxHeight = panel.scrollHeight + "px";
      toggle.setAttribute("aria-expanded", "true");
    }

    function closePanel() {
      shell.classList.remove("toc-shell--open");
      panel.classList.remove("toc-panel--open");
      panel.style.maxHeight = "0px";
      toggle.setAttribute("aria-expanded", "false");
    }

    function togglePanel() {
      if (panel.classList.contains("toc-panel--open")) {
        closePanel();
      } else {
        panel.style.maxHeight = panel.scrollHeight + "px";
        openPanel();
      }
    }

    toggle.addEventListener("click", togglePanel);

    // Initial: desktop open, mobile closed
    if (isMobile()) {
      closePanel();
    } else {
      panel.style.maxHeight = panel.scrollHeight + "px";
      openPanel();
    }

    // Active heading scrollspy
    var activeId = null;

    function markActive(id) {
      if (activeId === id) return;
      activeId = id;

      links.forEach(function (a) {
        var href = a.getAttribute("href") || "";
        var linkId = href.split("#").slice(-1)[0];
        var isActive = linkId === id;
        a.classList.toggle("toc-link--active", isActive);
      });

      headings.forEach(function (h) {
        var hid = h.getAttribute("id");
        if (hid === id) {
          h.setAttribute("data-toc-active", "true");
        } else {
          h.removeAttribute("data-toc-active");
        }
      });
    }

    var observer = new IntersectionObserver(function (entries) {
      entries.forEach(function (entry) {
        if (!entry.isIntersecting) return;
        var id = entry.target.getAttribute("id");
        if (id) markActive(id);
      });
    }, {
      root: null,
      rootMargin: "-55% 0px -40% 0px",
      threshold: [0, 1]
    });

    headings.forEach(function (h) {
      observer.observe(h);
    });

    function handleScroll() {
      var docHeight = Math.max(
        document.body.scrollHeight,
        document.documentElement.scrollHeight
      );
      var viewport = window.innerHeight || document.documentElement.clientHeight;
      var max = docHeight - viewport;

      if (max <= 0) {
        setProgress(0);
        return;
      }

      var y = window.scrollY || window.pageYOffset || 0;
      var p = y / max;
      setProgress(p);
    }

    handleScroll();
    window.addEventListener("scroll", handleScroll, { passive: true });

    window.addEventListener("resize", function () {
      if (isMobile()) {
        if (!panel.classList.contains("toc-panel--open")) {
          panel.style.maxHeight = "0px";
        }
      } else {
        if (panel.classList.contains("toc-panel--open")) {
          panel.style.maxHeight = panel.scrollHeight + "px";
        }
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    var shells = document.querySelectorAll("[data-toc]");
    shells.forEach(setupToc);
  });
})();
</script>
{% endif %}
