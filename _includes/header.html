<!-- _includes/header.html -->
<header class="island-navbar" role="navigation" aria-label="Primary" id="site-navbar">
  <!-- Brand -->
  <a href="{{ '/' | relative_url }}" class="navbar-brand">
    <img
      src="{{ site.avatarurl | default: site.logo | default: 'https://i.pravatar.cc/64?u=j' }}"
      alt="{{ site.title | default: 'Site' | escape }}"
      class="navbar-avatar"
      width="32" height="32" loading="lazy"
    />
    <span class="brand-text">
      <span class="logo">{{ site.title | default: 'John Doe' }}</span>
      <span class="logo-sub">{{ site.job_title | default: 'Software Engineer' }}</span>
    </span>
  </a>

  <!-- Desktop menu (from _config.yml → navigation_header) -->
  <nav class="navbar-menu" aria-label="Desktop Navigation">
    <ul>
      {% assign nav_items = site.navigation_header %}
      {% if nav_items and nav_items.size > 0 %}
        {% for item in nav_items %}
          {% assign href = item.url %}
          {% assign is_external = href contains '://' %}
          <li>
            <a
              href="{% if is_external %}{{ href }}{% else %}{{ href | relative_url }}{% endif %}"
              {% if is_external %}target="_blank" rel="noopener noreferrer"{% endif %}
              class="{% if page.url == href %}active{% endif %}"
            >
              <i class="ph-bold ph-{{ item.icon | default: 'dot-outline' }}"></i>
              {{ item.title }}
            </a>
          </li>
        {% endfor %}
      {% endif %}
    </ul>
  </nav>

  <!-- Search bar (hidden by default; shown when header.has-search / .is-searching) -->
  <form class="navbar-search" role="search" onsubmit="return false;" aria-label="Site search">
    <div class="search-field">
      <i class="ph-bold ph-magnifying-glass" aria-hidden="true"></i>
      <input id="nav-search-input" type="search" placeholder="Search projects, posts, skills…" autocomplete="off" />
    </div>
    <div class="search-actions">
      <button type="button" id="nav-search-submit" class="search-btn">Search</button>
      <button type="button" id="nav-search-cancel" class="cancel-btn">Cancel</button>
    </div>
    <!-- suggestions -->
    <div class="search-suggestions" id="nav-suggestions" aria-live="polite" aria-label="Suggestions"></div>
  </form>

  <!-- Actions -->
  <div class="navbar-actions">
    <button class="nav-icon" id="search-open" aria-label="Search">
      <i class="ph-bold ph-magnifying-glass"></i>
    </button>

    <button class="theme-toggle-button nav-icon" aria-label="Toggle theme" id="theme-toggle" aria-pressed="false">
      <i class="ph-bold ph-sun icon-sun" aria-hidden="true"></i>
      <i class="ph-bold ph-moon icon-moon" aria-hidden="true"></i>
    </button>

    <a href="{{ site.repo | default: site.github_url | default: 'https://github.com/your-username' }}"
       target="_blank" rel="noopener noreferrer" class="nav-cta cta-github">
      <i class="ph-bold ph-star"></i><span>Star on GitHub</span>
    </a>

    <button class="mobile-menu-toggle nav-icon" id="mobile-menu-toggle"
            aria-label="Open menu" aria-controls="nav-expando" aria-expanded="false">
      <i class="ph-bold ph-list"></i>
    </button>
  </div>

  <!-- Mobile expando IN the navbar (island body) -->
  <div class="navbar-expando" id="nav-expando" aria-hidden="true">
    <div class="expando-divider" aria-hidden="true"></div>
    <nav class="bento-grid" role="menu" aria-label="Quick actions">
      {% assign mobile_items = site.navigation_header %}
      {% if mobile_items and mobile_items.size > 0 %}
        {% for item in mobile_items %}
          {% assign href = item.url %}
          {% assign is_external = href contains '://' %}
          <a class="bento-card"
             href="{% if is_external %}{{ href }}{% else %}{{ href | relative_url }}{% endif %}"
             {% if is_external %}target="_blank" rel="noopener"{% endif %}
             role="menuitem">
            <span class="bento-icon"><i class="ph-bold ph-{{ item.icon | default: 'dot-outline' }}"></i></span>
            <span>
              <div class="bento-title">{{ item.title }}</div>
              <div class="bento-sub">{{ item.sub | default: 'Open' }}</div>
            </span>
          </a>
        {% endfor %}
      {% endif %}
    </nav>
  </div>
</header>

<!-- Phosphor Icons (if not already in your layout head) -->
<script defer src="https://unpkg.com/@phosphor-icons/web"></script>

<script>
/* FOUC guard */
(function () {
  var KEY = "color-scheme";
  try {
    var saved = localStorage.getItem(KEY);
    var system = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    var theme = saved || system || "light";
    document.documentElement.setAttribute("data-color-scheme", theme);
  } catch(e){}
})();

/* Header interactions */
document.addEventListener("DOMContentLoaded", function () {
  var root       = document.documentElement;
  var header     = document.getElementById('site-navbar');
  var expando    = document.getElementById('nav-expando');
  var toggle     = document.getElementById('mobile-menu-toggle');
  var themeBtn   = document.getElementById('theme-toggle');
  var searchOpen = document.getElementById('search-open');

  var searchForm   = document.querySelector('.navbar-search');
  var searchInput  = document.getElementById('nav-search-input');
  var searchSubmit = document.getElementById('nav-search-submit');
  var searchCancel = document.getElementById('nav-search-cancel');
  var suggestions  = document.getElementById('nav-suggestions');

  // ---- Theme toggle ----
  var KEY = "color-scheme";
  function getTheme(){ return root.getAttribute("data-color-scheme") || "light"; }
  function setTheme(theme){
    root.setAttribute("data-color-scheme", theme);
    try { localStorage.setItem(KEY, theme); } catch(e){}
    if (themeBtn) themeBtn.setAttribute("aria-pressed", String(theme === "dark"));
  }
  try {
    var saved = localStorage.getItem(KEY);
    if (saved && saved !== getTheme()) setTheme(saved);
  } catch(e){}
  themeBtn && themeBtn.addEventListener("click", function(){
    setTheme(getTheme() === "light" ? "dark" : "light");
  });

  // ---- Layout helpers ----
  function setNavHeightVar() {
    var h = header ? header.getBoundingClientRect().height : 58;
    root.style.setProperty("--nav-h", h + "px");
  }
  function applyMobileMode() {
    var isMobile = window.matchMedia("(max-width: 991px)").matches;
    document.body.classList.toggle("has-fixed-nav", isMobile);
    setNavHeightVar();
  }
  applyMobileMode();
  window.addEventListener("resize", setNavHeightVar);
  window.addEventListener("orientationchange", setNavHeightVar);
  setTimeout(setNavHeightVar, 120);

  // ---- Mobile Expando ----
  function setExpandoHeight(open){
    if (!expando) return;
    if (open) {
      expando.style.maxHeight = "0px";
      requestAnimationFrame(function(){ expando.style.maxHeight = expando.scrollHeight + "px"; });
    } else {
      expando.style.maxHeight = expando.scrollHeight + "px";
      requestAnimationFrame(function(){ expando.style.maxHeight = "0px"; });
    }
  }
  function openExpando(){
    header && header.classList.add("is-open");
    expando && expando.classList.add("is-open");
    expando && expando.setAttribute("aria-hidden","false");
    toggle && toggle.setAttribute("aria-expanded","true");
    document.body.classList.add("panel-open");
    setExpandoHeight(true);
    setNavHeightVar();
  }
  function closeExpando(){
    header && header.classList.remove("is-open");
    expando && expando.classList.remove("is-open");
    expando && expando.setAttribute("aria-hidden","true");
    toggle && toggle.setAttribute("aria-expanded","false");
    document.body.classList.remove("panel-open");
    setExpandoHeight(false);
    setNavHeightVar();
  }
  function toggleExpando(){ expando && (expando.classList.contains("is-open") ? closeExpando() : openExpando()); }
  toggle && toggle.addEventListener("click", toggleExpando);
  expando && expando.addEventListener("click", function(e){ if(e.target.closest("a")) closeExpando(); });
  document.addEventListener("keydown", function(e){ if(e.key === "Escape" && expando && expando.classList.contains("is-open")) closeExpando(); });
  var mq = window.matchMedia("(min-width: 992px)");
  mq.addEventListener("change", function(){ if (mq.matches) closeExpando(); });

  // ---- Search Mode (turn navbar into search form) ----
  function enterSearch(){
    header.classList.add("is-searching");
    // close mobile expando if open
    if (expando && expando.classList.contains("is-open")) closeExpando();
    // focus
    if (searchInput) {
      searchInput.value = "";
      suggestions.innerHTML = "";
      setTimeout(function(){ searchInput.focus(); }, 30);
    }
    setNavHeightVar();
  }
  function exitSearch(){
    header.classList.remove("is-searching");
    suggestions.innerHTML = "";
    setNavHeightVar();
  }
  searchOpen && searchOpen.addEventListener("click", function(e){
    e.preventDefault();
    enterSearch();
  });
  searchCancel && searchCancel.addEventListener("click", function(){ exitSearch(); });

  // dummy suggestion data (merge nav items + extras)
  var data = [
    {% for item in site.navigation_header %}
      { t: {{ item.title | jsonify }}, u: {{ item.url | jsonify }} },
    {% endfor %}
    { t: "Hire Me", u: "/#hire" },
    { t: "Next.js", u: "/tags/nextjs/" },
    { t: "TypeScript", u: "/tags/typescript/" },
    { t: "React", u: "/tags/react/" }
  ];

  function renderSuggestions(q){
    if (!suggestions) return;
    suggestions.innerHTML = "";
    if (!q || q.trim().length < 1) { suggestions.classList.remove('has-results'); return; }
    var needle = q.toLowerCase();
    var results = data.filter(function(d){ return d.t.toLowerCase().indexOf(needle) !== -1; }).slice(0,6);
    if (!results.length) { suggestions.classList.remove('has-results'); return; }
    var list = document.createElement('ul');
    results.forEach(function(r){
      var li = document.createElement('li');
      var a  = document.createElement('a');
      a.href = r.u;
      a.textContent = r.t;
      li.appendChild(a);
      list.appendChild(li);
    });
    suggestions.appendChild(list);
    suggestions.classList.add('has-results');
  }

  searchInput && searchInput.addEventListener('input', function(e){
    renderSuggestions(e.target.value);
  });
  searchSubmit && searchSubmit.addEventListener('click', function(){
    // you can wire to your search page later
    exitSearch();
  });
});
</script>
