<!-- header.html â€” fixed mobile navbar + icons + bento + theme switcher + JSON-LD -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/bold/style.css">

<header class="island-navbar" role="navigation" aria-label="Primary" id="site-navbar">
  <a href="{{ '/' | relative_url }}" class="navbar-brand">
    {% if site.logo %}
      <img src="{{ site.logo | relative_url }}" alt="{{ site.title }}" class="navbar-avatar">
    {% else %}
      <img src="https://i.pravatar.cc/40?u={{ site.title | uri_escape }}" alt="{{ site.title }}" class="navbar-avatar">
    {% endif %}
    <span class="brand-text">
      <span class="logo">{{ site.title }}</span>
      <span class="logo-sub">
        {% if site.job_title %}{{ site.job_title }}{% elsif site.description %}{{ site.description }}{% else %}Website{% endif %}
      </span>
    </span>
  </a>

  <nav class="navbar-menu" aria-label="Desktop Navigation">
    <ul>
      {% for item in site.navigation_header %}
        <li>
          <a href="{{ item.url | relative_url }}" class="{% if page.url == item.url %}active{% endif %}">
            <i class="ph-bold ph-{{ item.icon | default: 'circle' }}"></i>
            {{ item.title }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </nav>

  <div class="navbar-actions">
    <a href="{{ '/search/' | relative_url }}" class="button-icon button-sm button-transparent" aria-label="Search">
      <i class="ph-bold ph-magnifying-glass" style="font-size: 1.25em;"></i>
    </a>

    <!-- Theme switcher -->
    <button class="theme-toggle-button button-icon button-sm" aria-label="Toggle theme" id="theme-toggle" aria-pressed="false">
      <i class="ph-bold ph-sun icon-sun" aria-hidden="true"></i>
      <i class="ph-bold ph-moon icon-moon" aria-hidden="true"></i>
    </button>

    {% if site.repo %}
      <a href="{{ site.repo }}" target="_blank" rel="noopener" class="button button-sm cta-github">
        <i class="ph-bold ph-star"></i><span>Star on GitHub</span>
      </a>
    {% endif %}

    <button class="mobile-menu-toggle button button-sm button-transparent button-icon" id="mobile-menu-toggle" aria-label="Open menu" aria-controls="mobile-panel" aria-expanded="false">
      <i class="ph-bold ph-list"></i>
    </button>
  </div>
</header>

<section id="mobile-panel" class="island-panel" aria-hidden="true">
  <div class="island-panel__inner">
    <div class="bento-grid">
      {% for item in site.navigation_header %}
        <a class="bento-card" href="{{ item.url | relative_url }}">
          <span class="bento-icon"><i class="ph-bold ph-{{ item.icon | default: 'caret-right' }}"></i></span>
          <span>
            <div class="bento-title">{{ item.title }}</div>
            <div class="bento-sub">{{ item.subtitle | default: 'Open section' }}</div>
          </span>
        </a>
      {% endfor %}
    </div>
  </div>
</section>

<!-- JSON-LD: Person + WebSite -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": {{ site.title | jsonify }},
  "jobTitle": {{ site.job_title | default: site.description | jsonify }},
  "url": {{ site.url | append: site.baseurl | jsonify }}{% if site.logo %},
  "image": {{ site.url | append: site.logo | jsonify }}{% endif %},
  "sameAs": [{% assign links = site.social_links %}{% assign first = true %}
    {% if links.Twitter %}{% unless first %}, {% endunless %}{{ links.Twitter | jsonify }}{% assign first = false %}{% endif %}
    {% if links.LinkedIn %}{% unless first %}, {% endunless %}{{ links.LinkedIn | jsonify }}{% assign first = false %}{% endif %}
    {% if links.GitHub %}{% unless first %}, {% endunless %}{{ links.GitHub | jsonify }}{% assign first = false %}{% endif %}
    {% if links.link %}{% unless first %}, {% endunless %}{{ links.link | jsonify }}{% assign first = false %}{% endif %}
    {% if links.RSS %}{% unless first %}, {% endunless %}{{ site.url | append: links.RSS | jsonify }}{% assign first = false %}{% endif %}
  ]
}
</script>
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"WebSite",
  "name": {{ site.title | jsonify }},
  "url": {{ site.url | append: site.baseurl | jsonify }},
  "potentialAction":{
    "@type":"SearchAction",
    "target": {{ site.url | append: site.baseurl | append: "/search/?q={search_term_string}" | jsonify }},
    "query-input":"required name=search_term_string"
  }
}
</script>

<script>
  // ---- FOUC guard: decide theme before first paint ----
  (function () {
    var KEY = "color-scheme";
    var saved = localStorage.getItem(KEY);
    var system = (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) ? "dark" : "light";
    var theme = saved || system || "light";
    document.documentElement.setAttribute("data-color-scheme", theme);
  })();

  document.addEventListener("DOMContentLoaded", function () {
    var root   = document.documentElement;
    var KEY    = "color-scheme";
    var btn    = document.getElementById("theme-toggle");
    var menu   = document.getElementById("mobile-panel");
    var toggle = document.getElementById("mobile-menu-toggle");
    var bar    = document.getElementById("site-navbar");

    // measure nav height for fixed layout on mobile
    function setNavHeightVar() {
      if (!bar) return;
      var h = bar.getBoundingClientRect().height;
      document.body.classList.add("has-fixed-nav");
      root.style.setProperty("--nav-h", h + "px");
    }
    setNavHeightVar();
    window.addEventListener("resize", setNavHeightVar);

    // THEME SWITCH (animated)
    function getTheme(){ return root.getAttribute("data-color-scheme") || "light"; }
    function setTheme(t){
      root.setAttribute("data-color-scheme", t);
      localStorage.setItem(KEY, t);
      if (btn) btn.setAttribute("aria-pressed", String(t === "dark"));
    }
    setTheme(localStorage.getItem(KEY) || getTheme());
    if (btn) btn.addEventListener("click", function(){ setTheme(getTheme() === "light" ? "dark" : "light"); });

    // BENTO PANEL (use max-height cap so content never hides; inner scrolls)
    function openPanel(){
      if (!menu || !toggle || !bar) return;
      bar.classList.add("is-open");
      menu.classList.add("is-open");
      menu.setAttribute("aria-hidden","false");
      toggle.setAttribute("aria-expanded","true");
      menu.style.maxHeight = "90vh";
    }
    function closePanel(){
      if (!menu || !toggle || !bar) return;
      bar.classList.remove("is-open");
      menu.classList.remove("is-open");
      menu.setAttribute("aria-hidden","true");
      toggle.setAttribute("aria-expanded","false");
      menu.style.maxHeight = "0px";
    }
    function togglePanel(){ (menu && menu.classList.contains("is-open")) ? closePanel() : openPanel(); }

    if (toggle) toggle.addEventListener("click", togglePanel);
    if (menu)   menu.addEventListener("click", function(e){ if (e.target.closest("a")) closePanel(); });
    document.addEventListener("keydown", function(e){ if (e.key === "Escape" && menu && menu.classList.contains("is-open")) closePanel(); });

    // close panel when switching to desktop width
    var mq = window.matchMedia("(min-width: {{ site.bp_lg | default: '992px' }})");
    if (mq && mq.addEventListener) mq.addEventListener("change", function(){ if (mq.matches) closePanel(); });
  });
</script>
