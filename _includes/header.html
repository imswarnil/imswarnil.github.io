{% comment %}
  Header include
  - Respects site.header settings (sticky, fullwidth, rounded, toggles)
  - Uses navigation_header with optional children for submenus
{% endcomment %}

{%- assign header_show_search    = true -%}
{%- assign header_show_social    = true -%}
{%- assign header_show_avatar    = true -%}
{%- assign header_show_job_title = true -%}
{%- assign header_show_nav_icons = true -%}
{%- assign header_sticky         = true -%}
{%- assign header_fullwidth      = false -%}
{%- assign header_rounded        = true -%}

{%- if site.header -%}
  {%- if site.header.show_search == false    -%}{%- assign header_show_search    = false -%}{%- endif -%}
  {%- if site.header.show_social == false    -%}{%- assign header_show_social    = false -%}{%- endif -%}
  {%- if site.header.show_avatar == false    -%}{%- assign header_show_avatar    = false -%}{%- endif -%}
  {%- if site.header.show_job_title == false -%}{%- assign header_show_job_title = false -%}{%- endif -%}
  {%- if site.header.show_nav_icons == false -%}{%- assign header_show_nav_icons = false -%}{%- endif -%}
  {%- if site.header.sticky == false         -%}{%- assign header_sticky         = false -%}{%- endif -%}
  {%- if site.header.fullwidth == true       -%}{%- assign header_fullwidth      = true  -%}{%- endif -%}
  {%- if site.header.rounded == false        -%}{%- assign header_rounded        = false -%}{%- endif -%}
{%- endif -%}

{%- assign header_classes = 'island-navbar' -%}
{%- if header_fullwidth -%}
  {%- assign header_classes = header_classes | append: ' island-navbar--fullwidth' -%}
{%- endif -%}
{%- unless header_rounded -%}
  {%- assign header_classes = header_classes | append: ' island-navbar--square' -%}
{%- endunless -%}
{%- unless header_sticky -%}
  {%- assign header_classes = header_classes | append: ' island-navbar--static' -%}
{%- endunless -%}

<header class="{{ header_classes }}"
        role="navigation"
        aria-label="Primary"
        id="site-navbar"
        data-sticky="{{ header_sticky }}">
  <a href="{{ '/' | relative_url }}" class="navbar-brand">
    {% if header_show_avatar %}
      <img
        src="{{ site.avatarurl | default: site.logo | default: 'https://i.pravatar.cc/64?u=j' }}"
        alt="{{ site.title | default: 'Site' | escape }}"
        class="navbar-avatar"
        width="32" height="32" loading="lazy"
      />
    {% endif %}
    <span class="brand-text">
      <span class="logo">{{ site.title | default: 'John Doe' }}</span>
      {% if header_show_job_title %}
        <span class="logo-sub">{{ site.job_title | default: 'Software Engineer' }}</span>
      {% endif %}
    </span>
  </a>

  <!-- Desktop menu (from _config.yml → navigation_header) -->
  <nav class="navbar-menu" aria-label="Desktop Navigation">
    <ul>
      {% assign nav_items = site.navigation_header %}
      {% if nav_items and nav_items.size > 0 %}
        {% for item in nav_items %}
          {% assign href = item.url %}
          {% assign is_external = false %}
          {% if href contains '://' %}{% assign is_external = true %}{% endif %}

          {% assign children = item.children %}
          <li class="{% if children %}nav-item-has-children{% endif %}">
            <a
              href="{% if is_external %}{{ href }}{% else %}{{ href | relative_url }}{% endif %}"
              {% if is_external %}target="_blank" rel="noopener noreferrer"{% endif %}
              class="{% if page.url == href %}active{% endif %}"
            >
              {% if header_show_nav_icons %}
                <i class="ph-bold ph-{{ item.icon | default: 'dot-outline' }}"></i>
              {% endif %}
              <span class="nav-label">{{ item.title }}</span>
              {% if children %}
                <span class="nav-chevron" aria-hidden="true">
                  <i class="ph-bold ph-caret-down"></i>
                </span>
              {% endif %}
            </a>

          {% if children %}
  <ul class="nav-submenu" aria-label="{{ item.title }} submenu">
    {% for child in children %}
      {% assign ch_href = child.url %}
      {% assign ch_is_external = false %}
      {% if ch_href contains '://' %}{% assign ch_is_external = true %}{% endif %}

      {% assign ch_icon = child.icon %}
      <li>
        <a href="{% if ch_is_external %}{{ ch_href }}{% else %}{{ ch_href | relative_url }}{% endif %}"
           {% if ch_is_external %}target="_blank" rel="noopener noreferrer"{% endif %}>
          {% if header_show_nav_icons and ch_icon %}
            <span class="nav-submenu-icon">
              <i class="ph-bold ph-{{ ch_icon }}"></i>
            </span>
          {% endif %}
          <span class="nav-submenu-label">
            {{ child.title }}
          </span>
        </a>
      </li>
    {% endfor %}
  </ul>
{% endif %}

          </li>
        {% endfor %}
      {% else %}
        <li><a href="{{ '/#about' | relative_url }}"><i class="ph-bold ph-user"></i><span class="nav-label">About</span></a></li>
        <li><a href="{{ '/#projects' | relative_url }}"><i class="ph-bold ph-folder"></i><span class="nav-label">Projects</span></a></li>
        <li><a href="{{ '/blog/' | relative_url }}"><i class="ph-bold ph-article"></i><span class="nav-label">Blog</span></a></li>
        <li><a href="{{ '/#contact' | relative_url }}"><i class="ph-bold ph-paper-plane-tilt"></i><span class="nav-label">Contact</span></a></li>
      {% endif %}
    </ul>
  </nav>

  {% if header_show_search %}
    <!-- Inline navbar search -->
    <form class="navbar-search" id="navbar-search" role="search" aria-label="Site search" autocomplete="off">
      <i class="ph-bold ph-magnifying-glass" aria-hidden="true"></i>
      <input class="search-input" id="navbar-search-input" type="search"
             placeholder="Search {{ site.title | escape }}…" aria-label="Search" />
      <button type="button" class="search-cancel" id="navbar-search-cancel" aria-label="Cancel search">
        <i class="ph-bold ph-x"></i>
      </button>
    </form>
  {% endif %}

  <!-- Actions -->
  <div class="navbar-actions">
    {% if header_show_search %}
      <!-- Use this to OPEN inline search (prevents navigation) -->
      <a href="{{ '/search/' | relative_url }}" id="search-open" class="nav-icon" aria-label="Search">
        <i class="ph-bold ph-magnifying-glass"></i>
      </a>
    {% endif %}

    <button class="theme-toggle-button" aria-label="Toggle theme" id="theme-toggle">
      <i class="ph-bold ph-sun icon-sun" aria-hidden="true"></i>
      <i class="ph-bold ph-moon icon-moon" aria-hidden="true"></i>
    </button>

    <a href="{{ site.repo | default: site.github_url | default: 'https://github.com/your-username' }}"
       target="_blank" rel="noopener noreferrer" class="nav-cta cta-github">
      <i class="ph-bold ph-star"></i><span>Star on GitHub</span>
    </a>

    <button class="mobile-menu-toggle nav-icon" id="mobile-menu-toggle"
            aria-label="Open menu" aria-controls="mobile-panel" aria-expanded="false">
      <i class="ph-bold ph-list"></i>
    </button>
  </div>
</header>

<!-- Floating mobile island panel -->
<section id="mobile-panel" class="island-panel" aria-hidden="true">
  <div class="island-panel__inner">
    <!-- Close button INSIDE the panel -->
    <button type="button" class="island-panel__close" id="mobile-panel-close" aria-label="Close menu">
      <span class="island-panel__close-icon" aria-hidden="true">&times;</span>
    </button>

    <!-- Nav list (mobile) -->
    <nav class="mobile-nav" aria-label="Mobile Navigation">
      {% assign mobile_items = site.navigation_header %}
      {% if mobile_items and mobile_items.size > 0 %}
        <ul class="mobile-nav-list">
          {% for item in mobile_items %}
            {% assign href = item.url %}
            {% assign is_external = false %}
            {% if href contains '://' %}{% assign is_external = true %}{% endif %}
            {% assign children = item.children %}
            {% assign has_children = children and children.size > 0 %}

            <li class="mobile-nav-item{% if has_children %} has-children{% endif %}">
              <div class="mobile-nav-row" data-mobile-parent>
                <a class="mobile-nav-link"
                   href="{% if is_external %}{{ href }}{% else %}{{ href | relative_url }}{% endif %}"
                   {% if is_external %}target="_blank" rel="noopener"{% endif %}>
                  <span class="mobile-nav-icon">
                    {% if header_show_nav_icons %}
                      <i class="ph-bold ph-{{ item.icon | default: 'dot-outline' }}"></i>
                    {% endif %}
                  </span>
                  <span class="mobile-nav-label">{{ item.title }}</span>
                </a>

                {% if has_children %}
                  <button type="button"
                          class="mobile-nav-toggle"
                          aria-label="Toggle {{ item.title }} submenu"
                          aria-expanded="false">
                    <i class="ph-bold ph-caret-down"></i>
                  </button>
                {% endif %}
              </div>

              {% if has_children %}
                <ul class="mobile-submenu" hidden>
                  {% for child in children %}
                    {% assign ch_href = child.url %}
                    {% assign ch_is_external = false %}
                    {% if ch_href contains '://' %}{% assign ch_is_external = true %}{% endif %}
                    <li>
                      <a href="{% if ch_is_external %}{{ ch_href }}{% else %}{{ ch_href | relative_url }}{% endif %}"
                         {% if ch_is_external %}target="_blank" rel="noopener noreferrer"{% endif %}>
                        {{ child.title }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="bento-grid" role="menu" aria-label="Quick actions">
          <a class="bento-card" href="{{ '/#about' | relative_url }}"><span class="bento-icon"><i class="ph-bold ph-user"></i></span><span><div class="bento-title">About</div><div class="bento-sub">Who I am</div></span></a>
          <a class="bento-card" href="{{ '/#projects' | relative_url }}"><span class="bento-icon"><i class="ph-bold ph-folder"></i></span><span><div class="bento-title">Projects</div><div class="bento-sub">Featured builds</div></span></a>
          <a class="bento-card" href="{{ '/blog/' | relative_url }}"><span class="bento-icon"><i class="ph-bold ph-article"></i></span><span><div class="bento-title">Blog</div><div class="bento-sub">Notes & essays</div></span></a>
          <a class="bento-card" href="{{ '/#contact' | relative_url }}"><span class="bento-icon"><i class="ph-bold ph-paper-plane-tilt"></i></span><span><div class="bento-title">Contact</div><div class="bento-sub">Say hello</div></span></a>
        </div>
      {% endif %}
    </nav>

    {% if site.social_links and header_show_social %}
      <div class="panel-social">
        <div class="panel-social__heading">Connect</div>
        <div class="panel-social__grid">
          {% for pair in site.social_links %}
            {% assign label = pair[0] %}
            {% assign url   = pair[1] %}

            {% assign icon_class = '' %}
            {% case label %}
              {% when 'Twitter' %}
                {% assign icon_class = 'twitter-logo' %}
              {% when 'LinkedIn' %}
                {% assign icon_class = 'linkedin-logo' %}
              {% when 'GitHub' %}
                {% assign icon_class = 'github-logo' %}
              {% when 'RSS' %}
                {% assign icon_class = 'rss-simple' %}
              {% when 'link' %}
                {% assign icon_class = 'link-simple' %}
              {% when 'Link' %}
                {% assign icon_class = 'link-simple' %}
              {% else %}
                {% assign icon_class = 'link-simple' %}
            {% endcase %}

            {% assign is_external = false %}
            {% if url contains '://' %}{% assign is_external = true %}{% endif %}

            <a class="panel-social__item"
               href="{% if is_external %}{{ url }}{% else %}{{ url | relative_url }}{% endif %}"
               {% if is_external %}target="_blank" rel="noopener noreferrer"{% endif %}>
              <span class="panel-social__icon">
                <i class="ph-duotone ph-{{ icon_class }}"></i>
              </span>
              <span class="panel-social__label">{{ label }}</span>
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
</section>

{% if header_show_search %}
  <!-- Results panel, docked under the island -->
  <section id="search-results" class="search-results" aria-live="polite" aria-label="Search results"></section>
{% endif %}

{%- comment -%}
  JSON-LD for SEO:
  - Person (you)
  - SiteNavigationElement (top nav)
  - WebSite SearchAction (search)
{%- endcomment -%}

{% assign abs_home = '/' | absolute_url %}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "{{ site.author.name | default: site.title | escape }}",
  "url": "{{ abs_home }}",
  "jobTitle": "{{ site.job_title | escape }}",
  "image": "{{ site.avatarurl | default: site.logo | default: '' | absolute_url }}",
  "sameAs": [
    {% if site.social_links %}
      {%- assign first = true -%}
      {%- for pair in site.social_links -%}
        {%- assign url = pair[1] -%}
        {%- unless first -%},{%- endunless -%}
        "{{ url | absolute_url }}"
        {%- assign first = false -%}
      {%- endfor -%}
    {% endif %}
  ]
}
</script>

{% if site.navigation_header %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SiteNavigationElement",
  "name": "{{ site.title | escape }} navigation",
  "url": "{{ abs_home }}",
  "hasPart": [
    {%- for item in site.navigation_header -%}
      {
        "@type": "WebPage",
        "name": "{{ item.title | escape }}",
        "url": "{% if item.url contains '://' %}{{ item.url }}{% else %}{{ item.url | relative_url | absolute_url }}{% endif %}"
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ]
}
</script>
{% endif %}

{% if header_show_search %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "{{ site.title | escape }}",
  "url": "{{ abs_home }}",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "{{ '/search/' | relative_url | absolute_url }}?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
{% endif %}

<script>
  /* assets/scripts/header.js */

  // FOUC guard — theme from localStorage / system
  (function () {
    var KEY = "color-scheme";
    try {
      var saved = localStorage.getItem(KEY);
      var system = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      var theme = saved || system || "light";
      document.documentElement.setAttribute("data-color-scheme", theme);
    } catch (e) {}
  })();

  document.addEventListener("DOMContentLoaded", function () {
    var root     = document.documentElement;
    var body     = document.body;
    var header   = document.getElementById("site-navbar");
    var panel    = document.getElementById("mobile-panel");
    var toggle   = document.getElementById("mobile-menu-toggle");
    var themeBtn = document.getElementById("theme-toggle");

    // ===========================
    // THEME TOGGLE (PERSISTENT)
    // ===========================
    var KEY = "color-scheme";
    function getTheme() {
      return root.getAttribute("data-color-scheme") || "light";
    }
    function setTheme(theme) {
      root.setAttribute("data-color-scheme", theme);
      try {
        localStorage.setItem(KEY, theme);
      } catch (e) {}
      if (themeBtn) themeBtn.setAttribute("aria-pressed", String(theme === "dark"));
    }

    try {
      var saved = localStorage.getItem(KEY);
      if (saved && saved !== getTheme()) setTheme(saved);
    } catch (e) {}

    themeBtn && themeBtn.addEventListener("click", function () {
      setTheme(getTheme() === "light" ? "dark" : "light");
    });

    // ===========================
    // LAYOUT + NAV HEIGHT
    // ===========================
    function setNavHeightVar() {
      var h = header ? header.getBoundingClientRect().height : 58;
      root.style.setProperty("--nav-h", h + "px");
    }

    function isMobile() {
      // match CSS breakpoint (max-width: $bp-lg ≈ 991px)
      return window.matchMedia("(max-width: 991px)").matches;
    }

    function applyLayout() {
      var mobile = isMobile();
      var isStaticHeader = header && header.classList.contains("island-navbar--static");

      // Only add padding for fixed mobile navbar (not static/overridden)
      body.classList.toggle("has-fixed-nav", mobile && !isStaticHeader);

      setNavHeightVar();

      // When switching to desktop, force panel closed so states don't get stuck
      if (!mobile) {
        closePanel();
      }
    }

    // Initial layout
    applyLayout();
    // After initial render (fonts / async stuff)
    window.setTimeout(applyLayout, 120);

    // On resize: recompute layout + height with rAF for smoother animation
    window.addEventListener("resize", function () {
      window.requestAnimationFrame(applyLayout);
    });
    window.addEventListener("orientationchange", applyLayout);

    // ===========================
    // MOBILE PANEL OPEN/CLOSE
    // ===========================
    function setPanelHeight(open) {
      if (!panel) return;
      if (open) {
        panel.style.maxHeight = "0px";
        requestAnimationFrame(function () {
          panel.style.maxHeight = panel.scrollHeight + "px";
        });
      } else {
        panel.style.maxHeight = panel.scrollHeight + "px";
        requestAnimationFrame(function () {
          panel.style.maxHeight = "0px";
        });
      }
    }

    function openPanel() {
      if (header) header.classList.add("is-open");
      if (panel) {
        panel.classList.add("is-open");
        panel.setAttribute("aria-hidden", "false");
      }
      if (toggle) toggle.setAttribute("aria-expanded", "true");
      body.classList.add("panel-open");
      setPanelHeight(true);
    }

    function closePanel() {
      if (header) header.classList.remove("is-open");
      if (panel) {
        panel.classList.remove("is-open");
        panel.setAttribute("aria-hidden", "true");
      }
      if (toggle) toggle.setAttribute("aria-expanded", "false");
      body.classList.remove("panel-open");
      setPanelHeight(false);
    }

    function togglePanel() {
      if (!panel) return;
      if (panel.classList.contains("is-open")) {
        closePanel();
      } else {
        openPanel();
      }
    }

    toggle && toggle.addEventListener("click", togglePanel);

    // Clicking a link inside the panel closes it
    panel && panel.addEventListener("click", function (e) {
      if (e.target.closest("a")) closePanel();
    });

    // Escape closes panel
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && panel && panel.classList.contains("is-open")) {
        closePanel();
      }
    });

    // Also react to breakpoint changes via matchMedia
    var mq = window.matchMedia("(min-width: 992px)");
    mq.addEventListener("change", function (e) {
      if (e.matches) {
        // now in desktop
        closePanel();
        applyLayout();
      } else {
        // now in mobile
        applyLayout();
      }
    });

    // ===========================
    // INLINE NAVBAR SEARCH
    // ===========================
    var openBtn = document.getElementById("search-open");
    var form    = document.getElementById("navbar-search");
    var input   = document.getElementById("navbar-search-input");
    var cancel  = document.getElementById("navbar-search-cancel");
    var results = document.getElementById("search-results");
    var endpoint = "{{ '/assets/search.json' | relative_url }}";
    var PAGES = [];

    // Load search index once
    if (endpoint) {
      fetch(endpoint)
        .then(function (r) { return r.json(); })
        .then(function (data) { PAGES = data || []; })
        .catch(function () { PAGES = []; });
    }

    function openSearch() {
      body.classList.add("search-active");
      if (results) results.classList.add("is-open");
      setTimeout(function () { input && input.focus(); }, 10);
    }

    function clearResults() {
      if (results) results.innerHTML = "";
    }

    function closeSearch() {
      body.classList.remove("search-active");
      if (results) results.classList.remove("is-open");
      clearResults();
      if (input) input.value = "";
    }

    cancel && cancel.addEventListener("click", closeSearch);

    openBtn && openBtn.addEventListener("click", function (e) {
      e.preventDefault();
      openSearch();
    });

    // Click-away closes search (but not when clicking inside navbar/results)
    document.addEventListener("click", function (e) {
      if (!body.classList.contains("search-active")) return;
      if (e.target.closest(".island-navbar") || e.target.closest("#search-results")) return;
      closeSearch();
    });

    // Keyboard shortcuts: "/" to open, ESC to close, arrows for options
    document.addEventListener("keydown", function (e) {
      if (e.key === "/" && !body.classList.contains("search-active")) {
        e.preventDefault();
        openSearch();
      } else if (e.key === "Escape" && body.classList.contains("search-active")) {
        e.preventDefault();
        closeSearch();
      } else if (
        body.classList.contains("search-active") &&
        ["ArrowDown", "ArrowUp", "Enter"].includes(e.key)
      ) {
        if (!results) return;
        var opts = Array.from(results.querySelectorAll('.search-item[role="option"]'));
        if (!opts.length) return;
        var cur = opts.findIndex(function (el) {
          return el.getAttribute("aria-selected") === "true";
        });

        if (e.key === "ArrowDown") {
          cur = (cur + 1) % opts.length;
          highlight(cur);
          e.preventDefault();
        }
        if (e.key === "ArrowUp") {
          cur = (cur - 1 + opts.length) % opts.length;
          highlight(cur);
          e.preventDefault();
        }
        if (e.key === "Enter" && cur >= 0) {
          opts[cur].click();
        }
      }
    });

    var timer = null;
    input && input.addEventListener("input", function () {
      clearTimeout(timer);
      var q = (this.value || "").trim();
      timer = setTimeout(function () {
        renderSearch(q);
      }, 120);

      if (!results) return;
      if (q && !results.classList.contains("is-open")) results.classList.add("is-open");
      if (!q && results.classList.contains("is-open")) results.classList.remove("is-open");
    });

    // Prevent full-page submit; just go to first result
    form && form.addEventListener("submit", function (e) {
      e.preventDefault();
      if (!results) return;
      var first = results.querySelector('.search-item[role="option"] a[href]');
      if (first) {
        window.location.href = first.getAttribute("href");
        closeSearch();
      }
    });

    function findResults(term, pages) {
      if (!term) return [];
      var regex = new RegExp(term, "gi");
      return (pages || []).filter(function (item) {
        return (
          (item.title && item.title.match(regex)) ||
          (item.content && item.content.match(regex))
        );
      });
    }

    function renderSearch(q) {
      if (!results) return;
      var arr = findResults(q, PAGES).slice(0, 12);

      if (!q || !arr.length) {
        results.innerHTML =
          '<div class="search-list"><div class="search-item" aria-disabled="true" style="opacity:.75">No results</div></div>';
        return;
      }

      var html = ['<ul class="search-list" role="listbox">']
        .concat(
          arr.map(function (item, i) {
            var thumb = item.image
              ? '<div class="search-thumb"><img src="' + item.image + '" alt=""></div>'
              : '<div class="search-thumb"><i class="ph-bold ph-file-text"></i></div>';
            var url = item.url || "#";
            var safeTitle = item.title || "Untitled";
            var excerpt = item.excerpt || "";
            return (
              '<li class="search-item" role="option" data-index="' +
              i +
              '" tabindex="-1">' +
              thumb +
              '<div class="search-main">' +
              '<div class="search-title">' +
              safeTitle +
              "</div>" +
              '<div class="search-excerpt">' +
              excerpt +
              "</div>" +
              "</div>" +
              '<a class="search-cta" href="' +
              url +
              '">Open</a>' +
              "</li>"
            );
          })
        )
        .concat(["</ul>"])
        .join("");

      results.innerHTML = html;
      highlight(0);

      results.querySelectorAll(".search-item").forEach(function (li) {
        li.addEventListener("click", function (e) {
          if (e.target.tagName.toLowerCase() !== "a") {
            var a = li.querySelector("a[href]");
            if (a) {
              window.location.href = a.getAttribute("href");
            }
          }
          closeSearch();
        });
      });
    }

    function highlight(idx) {
      if (!results) return;
      var opts = results.querySelectorAll('.search-item[role="option"]');
      opts.forEach(function (el) {
        el.setAttribute("aria-selected", "false");
      });
      if (opts[idx]) {
        opts[idx].setAttribute("aria-selected", "true");
        opts[idx].scrollIntoView({ block: "nearest" });
      }
    }
  });
</script>
